# NewsApp ML Model Training Workflow
# Runs every 3 days to retrain the recommendation model
# Model is uploaded to Firestore for distribution to all app users

name: Train ML Model

on:
  # Scheduled trigger - every 3 days at 00:00 UTC
  schedule:
    - cron: '0 0 */3 * *'
  
  # Manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      force_train:
        description: 'Force training even with low data'
        required: false
        default: 'false'

jobs:
  train:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
      
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'ml_training/requirements.txt'
      
      - name: üì¶ Install dependencies
        run: |
          cd ml_training
          pip install -r requirements.txt
      
      - name: üîê Setup Firebase credentials
        env:
          FIREBASE_SERVICE_ACCOUNT_BASE64: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_BASE64 }}
        run: |
          if [ -z "$FIREBASE_SERVICE_ACCOUNT_BASE64" ]; then
            echo "‚ùå Error: FIREBASE_SERVICE_ACCOUNT_BASE64 secret not set"
            echo "Please add your Firebase service account key as a repository secret"
            exit 1
          fi
          echo "‚úÖ Firebase credentials found"
      
      - name: üß† Train ML Model
        env:
          FIREBASE_SERVICE_ACCOUNT_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_BASE64 }}
        run: |
          cd ml_training
          python train_model.py
      
      - name: üìä Training Summary
        if: always()
        run: |
          echo "================================================"
          echo "Training workflow completed at $(date)"
          echo "================================================"
